---
title: 跨域相关以及解决方案
date: 2021/2/4
tags: [跨域]
categories: 计算机网络
---

# 跨域

## 跨域是什么

> 资源所在的服务器地址与资源内发起请求的目标服务器地址不同源就是跨域

- 同源：协议，域名，端口都相等

## 解决 ajax 跨域的方法

- JSONP
- 服务器代理
- 添加跨域资源共享响应头

### <b style="color:skyblue">JSONP 的原理和实现</b>

- 简介：JSONP（json with padding）是在 web 服务器上流行的 JSON 变体（被包在回调函数里的 json）。
- 组成：JSONP 包含两个部分：回调函数和数据
  - 回调函数在页面接收到响应之后应该调用的函数
  - 数据是作为参数传给回调的 json 数据
- 原理：jsonp 服务通常支持以查询字符串的形式来指定回调函数的名称
  - `http://xxxx/?callback=handleResponse`该 jsonp 请求的回调函数就是 handleResponse
  - jsonp 调用是通过动态添加 script 标签并为 src 指定跨域的 url 来实现的，不使用 ajax 请求，只能使用 get 方法取回一个 js 文件（函数）
- 例子

```js
function handleResponse(response) {
  console.log(`...`)
}

let script documentCreateElement('script')
script.src = "http://xxxx/?callback=handleResponse"
document.body.appendChild(script)
```

- 优点：可直接访问响应，实现浏览器与服务器的双向通信
- 缺点：
  - 仅仅适用 get 请求方式
  - jsonp 从不同域中拉取可执行代码，如果该域不可信的话，可能会在响应中加入恶意内容
  - 不好确定 jsonp 请求是否失败

### <b style="color:skyblue">express 设置允许跨域请求</b>

```js
//设置跨域访问
app.all("*", function (req, res, next) {
  //设置允许跨域的域名，*代表允许任意域名跨域
  res.header("Access-Control-Allow-Origin", req.headers.origin || "*")
  // //允许的header类型
  res.header(
    "Access-Control-Allow-Headers",
    "Content-Type, Authorization, X-Requested-With"
  )
  // //跨域允许的请求方式
  res.header("Access-Control-Allow-Methods", "PUT,POST,GET,DELETE,OPTIONS")
  // 可以带cookies
  res.header("Access-Control-Allow-Credentials", true)
  if (req.method == "OPTIONS") {
    res.sendStatus(200)
  } else {
    next()
  }
})
```

### <b style="color:skyblue">CORS 跨域请求</b>

- 下载 cors 包 `npm i cors`
- 然后在 express 实例（app）使用.use 执行 require（"cors"）获得 cors 函数执行后返回的中间件

```js
const express = require("express")
const app = express()
app.use(require("cors")())
```

