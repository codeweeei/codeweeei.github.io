---
title: 浏览器工作原理—04输入URL到页面的导航阶段
date: 2021/6/1
tags:
categories: 浏览器工作原理与实践
---

# 导航流程：从输入 URL 到页面展示，这中间发生了什么？

> “在浏览器里，从输入 URL 到页面展示，这中间发生了什么？ ”这是一道经典的面试题

## 大致流程

- 流程图
  {% asset_img 输入url到完整展示流程图.png 输入url到完整展示流程图 %}
- 由图可得整个过程需要各个进程之间的配合

### 流程大致解释

1. 首先，用户从浏览器进程里输入请求信息
2. 然后，网络进程发起 URL 请求
3. 服务器响应 URL 请求之后，浏览器进程就又要开始准备渲染进程了
4. 渲染进程准备好之后，需要先向渲染进程提交页面数据，我们称之为提交文档阶段
5. 渲染进程接收完文档信息之后，便开始解析页面和加载子资源，完成页面的渲染

- 其中用户发出 URL 请求到页面开始解析的这个过程，就叫做导航流程

## 从输入 URL 到页面展示流程详细解释

### 用户地址栏输入 URL

1. 当用户在地址栏中输入一个查询关键字时，地址栏会判断输入的关键字是搜索内容，还是请求的 URL，如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。如果判断输入内容符合 URL 规则，比如输入的是 time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL，如 https://time.geekbang.org

### URL 请求过程

- 接下来，便进入了页面资源请求过程。这时，浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程
  1.  首先网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程。这请求前的第一步是要进行 DNS 解析，以获取请求域名的服务器 IP 地址。如果请求协议是 HTTPS，那么还需要建立 TLS 连接
  2.  接下来就是利用 IP 地址和服务器建立 TCP 连接。连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息
  3.  服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头和相应行的内容了
- 解析响应头的内容
  1. <span style="color:skyblue">重定向</span>：在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回的状态码是 301 或者 302，那么说明服务器需要浏览器重定向到其他 URL。这时网络进程会从响应头的 Location 字段里面读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求，一切又重头开始了，在导航过程中，如果服务器响应行的状态码包含了 301、302 一类的跳转信息，浏览器会跳转到新的地址继续导航；如果响应行是 200，那么表示浏览器可以继续处理该请求
  2. <span style="color:skyblue">响应数据类型处理</span>：URL 请求的数据类型，有时候是一个下载类型，有时候是正常的 HTML 页面，浏览器根据`Content-type`来判断服务器返回的响应体数据是什么类型，然后再决定如何显示响应体的内容
  - 从返回的响应头信息来看，其 Content-Type 的值是 application/octet-stream，显示数据是字节流类型的，通常情况下，浏览器会按照下载类型来处理该请求
  - 如果 Content-Type 字段的值被浏览器判断为下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程就此结束。但如果是 HTML，那么浏览器则会继续进行导航流程。由于 Chrome 的页面渲染是运行在渲染进程中的，所以接下来就需要准备渲染进程了
  3. <span style="color:skyblue">准备渲染进程</span>：默认情况下，Chrome 会为每个页面分配一个渲染进程，也就是说，每打开一个新页面就会配套创建一个新的渲染进程
  - 特殊情况：同一站点的多个页面运行在一个渲染进程中，是同一站点（same-site）。具体地讲，我们将“同一站点”定义为根域名（例如，geekbang.org）加上协议（例如，https:// 或者 http://），还包含了该根域名下的所有子域名和不同的端口
  ```
  它们都是属于同一站点，因为它们的协议都是 HTTPS，而且根域名也都是geekbang.org
  https://time.geekbang.org
  https://www.geekbang.org
  https://www.geekbang.org:8080
  ```
  - Chrome 的默认策略是，每个标签对应一个渲染进程。但如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫 process-per-site-instance
  - 渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段
  4. <span style="color:skyblue">提交文档</span>：这里文档即是 URL 请求的响应体数据
  - “提交文档”的消息是由浏览器进程发出的，渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”，等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程，浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面
  - 此时完整的导航流程基本就走完了，此后需要进入渲染阶段了
  5. <span style="color:skyblue">渲染阶段</span>：一旦文档被提交，渲染进程便开始页面解析和子资源加载了，关于这个阶段的完整过程，在下一篇文章中来专门介绍

## 总结

- 浏览器的导航过程涵盖了从用户发起请求到提交文档（数据）给渲染进程的中间所有阶段
- 导航过程是网络加载流程和渲染流程之间的一座桥梁
